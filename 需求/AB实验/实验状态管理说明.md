# 实验状态管理说明文档

## 一、状态定义

### 1.1 完整状态列表

| 状态值 | 中文名称 | 说明 |
|--------|---------|------|
| `creating` | 创建中 | 正在调用第三方接口创建实验，等待接口返回结果 |
| `updating` | 更新中 | 正在调用第三方接口更新实验，等待接口返回结果 |
| `pending` | 待开启 | 实验已创建/更新成功，但还未到设定的开始时间 |
| `running` | 实验中 | 实验正在进行中（当前时间在开始时间和结束时间之间） |
| `ended` | 已结束 | 实验已超过设定的结束时间 |
| `canceled` | 已取消 | 实验被手动取消 |
| `create_failed` | 创建失败 | 调用第三方接口创建实验失败 |
| `update_failed` | 更新失败 | 调用第三方接口更新实验失败 |

## 二、状态判断逻辑

### 2.1 判断优先级（从高到低）

状态判断按照以下优先级顺序进行：

1. **已取消状态** (`canceled`)
   - 条件：`canceledTime` 存在且小于等于当前时间
   - 说明：如果实验被标记为取消，无论其他条件如何，状态都是已取消

2. **操作中状态** (`creating` / `updating`)
   - 条件：`pendingOperation` 字段存在
     - `pendingOperation === 'create'` → `creating`
     - `pendingOperation === 'update'` → `updating`
   - 说明：当有异步操作正在进行时，优先显示操作状态

3. **失败状态** (`create_failed` / `update_failed`)
   - 条件：`lastError` 存在且 `lastOperation` 对应
     - `lastOperation === 'create'` → `create_failed`
     - `lastOperation === 'update'` → `update_failed`
   - 说明：如果最后一次操作失败，显示对应的失败状态

4. **时间相关状态** (`ended` / `running` / `pending`)
   - 判断顺序：
     - 如果 `endTime < 当前时间` → `ended`（已结束）
     - 如果 `startTime <= 当前时间 <= endTime` → `running`（实验中）
     - 如果 `startTime > 当前时间` → `pending`（待开启）

5. **默认状态**
   - 如果以上条件都不满足，使用 `currentStatus` 或默认 `pending`

### 2.2 状态转换流程图

```
创建实验
  ↓
[creating] → 成功 → [pending] → 到开始时间 → [running] → 到结束时间 → [ended]
  ↓
失败 → [create_failed]

编辑实验
  ↓
[updating] → 成功 → 重新计算状态（pending/running/ended）
  ↓
失败 → [update_failed]

任何状态 → 取消操作 → [canceled]
```

## 三、数据模型

### 3.1 实验对象字段说明

```javascript
{
  id: string,                    // 实验ID
  name: string,                  // 实验名称
  start: string,                 // 开始时间 (YYYY-MM-DD)
  end: string,                   // 结束时间 (YYYY-MM-DD)
  canceledTime: string,          // 取消时间 (YYYY-MM-DD，可选)
  pendingOperation: string,      // 待处理操作：'create' | 'update' | null
  lastOperation: string,         // 最后一次操作：'create' | 'update' | null
  lastError: Object,             // 最后一次错误信息（可选）
  currentStatus: string          // 当前存储的状态（用于回退）
}
```

### 3.2 字段使用说明

- **`pendingOperation`**: 
  - 在调用第三方接口前设置，表示有操作正在进行
  - 接口返回后清除（无论成功或失败）

- **`lastOperation`**: 
  - 记录最后一次操作类型（创建或更新）
  - 用于判断失败状态是创建失败还是更新失败

- **`lastError`**: 
  - 存储接口返回的错误信息
  - 用于判断和显示失败状态

- **`currentStatus`**: 
  - 存储最后一次计算的状态
  - 作为默认状态的回退值

- **`canceledTime`**: 
  - 记录取消时间
  - 一旦设置，实验状态即为已取消

## 四、核心函数说明

### 4.1 `calculateExperimentStatus(exp)`

**功能**：根据实验数据和时间自动计算当前状态

**参数**：
- `exp`: 实验对象

**返回**：状态字符串

**使用场景**：
- 页面加载时计算所有实验的状态
- 定时任务中定期更新实验状态
- 接口返回后重新计算状态

### 4.2 `setPendingOperation(exp, operation)`

**功能**：设置实验的待处理操作

**参数**：
- `exp`: 实验对象
- `operation`: 操作类型（'create' 或 'update'）

**使用场景**：
- 调用创建接口前：`setPendingOperation(exp, 'create')`
- 调用更新接口前：`setPendingOperation(exp, 'update')`

**效果**：
- 设置 `pendingOperation` 和 `lastOperation`
- 清除 `lastError`

### 4.3 `clearPendingOperation(exp, success, error)`

**功能**：清除待处理操作，处理接口返回结果

**参数**：
- `exp`: 实验对象
- `success`: 是否成功（boolean）
- `error`: 错误信息对象（可选）

**使用场景**：
- 接口调用成功：`clearPendingOperation(exp, true)`
- 接口调用失败：`clearPendingOperation(exp, false, errorObject)`

**效果**：
- 成功：清除 `pendingOperation` 和 `lastError`，重新计算状态
- 失败：清除 `pendingOperation`，设置 `lastError`，状态变为失败状态

### 4.4 `cancelExperiment(exp)`

**功能**：取消实验

**参数**：
- `exp`: 实验对象

**效果**：
- 设置 `canceledTime` 为当前日期
- 设置 `currentStatus` 为 'canceled'

## 五、使用示例

### 5.1 创建实验流程

```javascript
// 1. 创建实验对象
const newExp = {
  id: 'exp_001',
  name: '测试实验',
  start: '2025-12-01',
  end: '2025-12-31',
  // ... 其他字段
};

// 2. 设置待处理操作
setPendingOperation(newExp, 'create');
// 此时状态为 'creating'

// 3. 调用第三方接口
try {
  const result = await createExperimentAPI(newExp);
  
  // 4. 接口成功，清除待处理操作
  clearPendingOperation(newExp, true);
  // 此时会根据时间计算状态：pending/running/ended
  
} catch (error) {
  // 5. 接口失败，记录错误
  clearPendingOperation(newExp, false, error);
  // 此时状态为 'create_failed'
}
```

### 5.2 更新实验流程

```javascript
// 1. 获取现有实验
const exp = experiments.find(e => e.id === 'exp_001');

// 2. 更新实验数据
exp.name = '更新后的名称';
exp.start = '2025-12-05';

// 3. 设置待处理操作
setPendingOperation(exp, 'update');
// 此时状态为 'updating'

// 4. 调用第三方接口
try {
  const result = await updateExperimentAPI(exp.id, exp);
  
  // 5. 接口成功，清除待处理操作
  clearPendingOperation(exp, true);
  // 此时会根据新的时间重新计算状态
  
} catch (error) {
  // 6. 接口失败，记录错误
  clearPendingOperation(exp, false, error);
  // 此时状态为 'update_failed'
}
```

### 5.3 页面加载时计算状态

```javascript
// 从数据库加载所有实验
const experiments = await loadExperimentsFromDB();

// 为每个实验计算当前状态
experiments.forEach(exp => {
  exp.currentStatus = calculateExperimentStatus(exp);
});

// 渲染列表
renderTable(experiments);
```

### 5.4 定时更新状态

```javascript
// 每分钟检查一次实验状态
setInterval(() => {
  experiments.forEach(exp => {
    const newStatus = calculateExperimentStatus(exp);
    if (newStatus !== exp.currentStatus) {
      exp.currentStatus = newStatus;
      // 更新数据库
      updateExperimentStatus(exp.id, newStatus);
      // 刷新UI
      renderTable(experiments);
    }
  });
}, 60000); // 60秒
```

## 六、状态显示建议

### 6.1 状态标签颜色

| 状态 | 建议颜色 | 说明 |
|------|---------|------|
| `creating` | 蓝色 | 表示进行中的操作 |
| `updating` | 蓝色 | 表示进行中的操作 |
| `pending` | 灰色 | 表示等待状态 |
| `running` | 黄色/橙色 | 表示活跃状态 |
| `ended` | 绿色 | 表示完成状态 |
| `canceled` | 灰色 | 表示已取消 |
| `create_failed` | 红色 | 表示错误 |
| `update_failed` | 红色 | 表示错误 |

### 6.2 状态说明文案

- `creating`: "创建中" - 可添加 tooltip："正在创建实验，请稍候..."
- `updating`: "更新中" - 可添加 tooltip："正在更新实验，请稍候..."
- `pending`: "待开启" - 可添加 tooltip：显示开始时间
- `running`: "实验中" - 可添加 tooltip：显示结束时间
- `ended`: "已结束" - 可添加 tooltip：显示结束时间
- `canceled`: "已取消" - 可添加 tooltip：显示取消时间
- `create_failed`: "创建失败" - 可添加 tooltip：显示错误信息
- `update_failed`: "更新失败" - 可添加 tooltip：显示错误信息

## 七、注意事项

1. **时间同步**：确保服务器时间和第三方接口时间同步，避免状态判断错误

2. **状态持久化**：`pendingOperation` 和 `lastError` 应该存储在数据库中，以便页面刷新后仍能正确显示状态

3. **接口超时处理**：如果接口调用超时，应该：
   - 清除 `pendingOperation`
   - 设置 `lastError`
   - 状态变为对应的失败状态

4. **并发操作**：避免同时进行多个操作（如创建和更新同时进行），应该：
   - 检查 `pendingOperation` 是否存在
   - 如果存在，提示用户等待当前操作完成

5. **状态刷新**：建议定期（如每分钟）重新计算所有实验的状态，确保时间相关的状态（pending → running → ended）能够及时更新

6. **错误恢复**：对于失败状态，应该提供重试机制：
   - 创建失败：允许重新创建
   - 更新失败：允许重新更新

## 八、扩展建议

1. **操作历史记录**：可以添加 `operationHistory` 数组，记录所有操作的历史

2. **状态变更通知**：当状态自动变更时（如 pending → running），可以发送通知

3. **批量操作**：支持批量创建/更新实验时的状态管理

4. **状态统计**：提供各状态实验数量的统计功能






