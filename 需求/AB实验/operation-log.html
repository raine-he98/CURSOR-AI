<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>操作记录 - AB测试中心</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
    <style>
        body { background: #f5f7fa; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; }
        .main-container { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .card { border: none; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,.1); }
        .table { margin-bottom: 0; }
        .table thead th { font-size: 13px; color: #6c6f80; text-transform: uppercase; letter-spacing: .04em; background: #f8f9fa; border-bottom: 2px solid #e9ecef; }
        .table th, .table td { vertical-align: middle; padding: 12px; }
        .table tbody tr:hover { background-color: #f8f9fa; }
        .badge-operation { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .badge-create { background: #e3f2fd; color: #1976d2; }
        .badge-update { background: #fff3e0; color: #f57c00; }
        .badge-result { padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .badge-success { background: #d1e7dd; color: #0f5132; }
        .badge-failed { background: #f8d7da; color: #842029; }
        .text-muted-small { font-size: 12px; color: #6c757d; }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="card">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>操作类型</th>
                                <th>操作开始时间</th>
                                <th>操作结束时间</th>
                                <th>实验名称</th>
                                <th>开始日期</th>
                                <th>结束日期</th>
                                <th>实验标杆</th>
                                <th>实验对象</th>
                                <th>操作结果</th>
                                <th>失败原因</th>
                            </tr>
                        </thead>
                        <tbody id="operationLogTable">
                            <!-- 数据将通过JavaScript动态填充 -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        // 从URL参数获取实验ID
        const urlParams = new URLSearchParams(window.location.search);
        const experimentId = urlParams.get('id');
        
        // 模拟实验数据（实际应该从API获取）
        const mockExperiments = {
            // 这里可以根据不同的实验ID返回不同的数据
            'default': {
                name: '美国渠道标题A/B',
                start: '2025-12-01',
                end: '2026-01-05',
                groups: [
                    { name: '实验组1', benchmark: '标杆 1', object: ['Adset 1', 'Adset 2'] },
                    { name: '实验组2', benchmark: '标杆 2', object: ['Adset 3', 'Adset 4', 'Adset 5'] }
                ]
            }
        };
        
        // 根据实验ID生成操作记录（实际应该从API获取）
        function generateOperationLogs(expId) {
            // 模拟数据：根据实验ID获取实验信息
            const exp = mockExperiments[expId] || mockExperiments['default'];
            
            const logs = [];
            
            // 创建操作记录（每个实验组一条，记录所有字段）
            // 只有最新一条创建是成功状态，之前的创建都只能是失败状态
            const createLogs = [];
            exp.groups.forEach((group, index) => {
                createLogs.push({
                    id: `log_create_${index + 1}`,
                    operationType: 'create',
                    startTime: `2025-11-25 14:${30 + index}:25`,
                    endTime: `2025-11-25 14:${30 + index}:28`,
                    result: 'failed', // 默认都是失败，最后会修改最新一条为成功
                    failureReason: '接口调用超时，请重试', // 失败原因
                    experimentName: exp.name,
                    startDate: exp.start,
                    endDate: exp.end,
                    benchmark: group.benchmark, // 创建时记录实验标杆
                    object: Array.isArray(group.object) ? group.object : [group.object] // 创建时记录实验对象（支持多个）
                });
            });
            
            // 如果有创建记录，将最新一条（最后一条）设置为成功
            if (createLogs.length > 0) {
                createLogs[createLogs.length - 1].result = 'success';
                createLogs[createLogs.length - 1].failureReason = null; // 成功时没有失败原因
            }
            
            logs.push(...createLogs);
            
            // 更新操作记录（只记录变更的字段，不记录实验标杆和实验对象）
            // 更新1：只更新实验名称
            logs.push({
                id: 'log_update_1',
                operationType: 'update',
                startTime: '2025-11-28 09:20:10',
                endTime: '2025-11-28 09:20:15',
                result: 'success',
                failureReason: null, // 成功时没有失败原因
                experimentName: '美国渠道标题A/B（更新）',
                startDate: '-', // 未变更
                endDate: '-', // 未变更
                benchmark: '-', // 更新时不记录
                object: '-' // 更新时不记录
            });
            
            // 更新2：只更新开始日期
            logs.push({
                id: 'log_update_2',
                operationType: 'update',
                startTime: '2025-11-29 10:15:20',
                endTime: '2025-11-29 10:15:23',
                result: 'success',
                failureReason: null, // 成功时没有失败原因
                experimentName: '-', // 未变更
                startDate: '2025-12-05', // 变更
                endDate: '-', // 未变更
                benchmark: '-', // 更新时不记录
                object: '-' // 更新时不记录
            });
            
            // 更新3：只更新结束日期
            logs.push({
                id: 'log_update_3',
                operationType: 'update',
                startTime: '2025-12-01 14:30:10',
                endTime: '2025-12-01 14:30:25',
                result: 'failed', // 失败示例
                failureReason: '第三方接口返回错误：参数校验失败', // 失败原因
                experimentName: '-', // 未变更
                startDate: '-', // 未变更
                endDate: '2026-01-10', // 变更
                benchmark: '-', // 更新时不记录
                object: '-' // 更新时不记录
            });
            
            return logs;
        }
        
        // 格式化时间显示
        function formatDateTime(dateTime) {
            if (!dateTime || dateTime === '-') return '-';
            if (dateTime.includes(' ')) {
                const [date, time] = dateTime.split(' ');
                return `${date}<br><span class="text-muted-small">${time}</span>`;
            }
            return dateTime;
        }
        
        // 渲染操作记录表格
        function renderOperationLogTable(logs) {
            const tableBody = document.getElementById('operationLogTable');
            if (!logs || logs.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="10" class="text-center text-muted py-4">暂无操作记录</td></tr>';
                return;
            }
            
            tableBody.innerHTML = logs.map(log => `
                <tr>
                    <td>
                        <span class="badge-operation badge-${log.operationType === 'create' ? 'create' : 'update'}">
                            ${log.operationType === 'create' ? '创建' : '更新'}
                        </span>
                    </td>
                    <td>${formatDateTime(log.startTime)}</td>
                    <td>${formatDateTime(log.endTime)}</td>
                    <td>${log.experimentName === '-' ? '<span class="text-muted">-</span>' : log.experimentName}</td>
                    <td>${log.startDate === '-' ? '<span class="text-muted">-</span>' : log.startDate}</td>
                    <td>${log.endDate === '-' ? '<span class="text-muted">-</span>' : log.endDate}</td>
                    <td>${log.benchmark === '-' ? '<span class="text-muted">-</span>' : (log.benchmark || '-')}</td>
                    <td>${log.object === '-' ? '<span class="text-muted">-</span>' : (Array.isArray(log.object) ? log.object.join('<br>') : (log.object || '-'))}</td>
                    <td>
                        <span class="badge-result badge-${log.result === 'success' ? 'success' : 'failed'}">
                            ${log.result === 'success' ? '成功' : '失败'}
                        </span>
                    </td>
                    <td>${log.result === 'failed' && log.failureReason ? log.failureReason : '<span class="text-muted">-</span>'}</td>
                </tr>
            `).join('');
        }
        
        // 根据实验ID加载操作记录（这里使用模拟数据，实际应该调用API）
        function loadOperationLogs(expId) {
            // 实际应该调用API: fetch(`/api/experiments/${expId}/operation-logs`)
            // 这里使用模拟数据
            if (!expId) return [];
            return generateOperationLogs(expId);
        }
        
        // 初始化
        const logs = loadOperationLogs(experimentId);
        renderOperationLogTable(logs);
    </script>
</body>
</html>

